name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Test backend
      working-directory: ./backend
      run: cargo test
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
      
    - name: Test frontend
      working-directory: ./frontend
      run: npm run lint

  deploy-backend:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT_ID }}
    
    - name: Configure Docker
      run: gcloud auth configure-docker
    
    - name: Build and Push Docker Image
      run: |
        cd backend
        gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT_ID }}/text-editor-ai-backend
    
    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy text-editor-ai-backend \
          --image gcr.io/${{ secrets.GCP_PROJECT_ID }}/text-editor-ai-backend \
          --platform managed \
          --region us-central1 \
          --allow-unauthenticated \
          --set-env-vars GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
    
    - name: Get Backend URL
      id: backend-url
      run: |
        echo "url=$(gcloud run services describe text-editor-ai-backend --region=us-central1 --format='value(status.url)')" >> $GITHUB_OUTPUT
    
    - name: Comment Backend URL
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ Backend deployed successfully!\n\nğŸŒ Backend URL: ${{ steps.backend-url.outputs.url }}`
          })

  deploy-frontend:
    needs: [test, deploy-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Get Backend URL
      id: backend-url
      run: |
        echo "url=$(gcloud run services describe text-editor-ai-backend --region=us-central1 --format='value(status.url)')" >> $GITHUB_OUTPUT
    
    - name: Update API URL
      working-directory: ./frontend
      run: |
        # æ›´æ–° vercel.json ä¸­çš„åç«¯ URL
        sed -i "s|text-editor-ai-backend-xxxxx-uc.a.run.app|${{ steps.backend-url.outputs.url }}|g" vercel.json
        
        # æ›´æ–° App.tsx ä¸­çš„é»˜è®¤ URL
        sed -i "s|text-editor-ai-backend-xxxxx-uc.a.run.app|${{ steps.backend-url.outputs.url }}|g" src/App.tsx
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./frontend/dist
        publish_branch: gh-pages
        force_orphan: true
    
    - name: Comment Frontend URL
      uses: actions/github-script@v7
      with:
        script: |
          const repo = context.repo;
          const frontendUrl = `https://${repo.owner}.github.io/${repo.repo}`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸ¨ Frontend deployed successfully!\n\nğŸŒ Frontend URL: ${frontendUrl}\nğŸ”— Backend URL: ${{ steps.backend-url.outputs.url }}`
          }) 